set(SPV_SHADERS "SPV_SHADERS" CACHE STRING "")

file(
  GLOB_RECURSE 
  SHADERS
  CONFIGURE_DEPENDS 
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.vert"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.frag"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.comp"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.geom"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.tesc"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.tese"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.mesh"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.task"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.rgen"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.rchit"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.rmiss"
  "${CMAKE_CURRENT_SOURCE_DIR}/glsl/*.rcall"
)

set(SHADER_INCLUDE_DIR ${CMAKE_CURRENT_SOURCE_DIR}/include)

set(GENERATED_DIR "generated")
if (NOT EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/${GENERATED_DIR})
  file(MAKE_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/${GENERATED_DIR})
endif()

if (NOT EXISTS ${CMAKE_CURRENT_SOURCE_DIR}/${GENERATED_DIR}/spv)
  file(MAKE_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}/${GENERATED_DIR}/spv)
endif()


set(GENERATED_SPVS "")

foreach(SHADER ${SHADERS})
    get_filename_component(SHADER_NAME ${SHADER} NAME)
    set(SPV "${CMAKE_CURRENT_SOURCE_DIR}/${GENERATED_DIR}/spv/${SHADER_NAME}.spv")
    add_custom_command(
      OUTPUT ${SPV}
      COMMAND ${GLS} -I${SHADER_INCLUDE_DIR} -V100 -o ${SPV} ${SHADER}
      DEPENDS ${SHADER}
      WORKING_DIRECTORY ${CMAKE_CURRENT_SOURCE_DIR}
    )
    list(APPEND GENERATED_SPVS ${SPV})
endforeach()

add_custom_target(${SPV_SHADERS} DEPENDS ${GENERATED_SPVS} SOURCES ${SHADERS})


